#!/bin/zsh

# how to call:
# ytAudio "Artist" "Album" "Song name"
# or: ytAudio "Artist" "Song name"
# or: ytAudio URL

usage()
{
	echo 'Wrong number of arguments
how to call:
	ytAudio "URL" "ARTIST" "ALBUM" (URL to album picture)'
	exit 2
}

download_audio(){
	# export album="$2"
	# youtube-dl -f bestaudio --write-thumbnail -o "%(title)s.%(ext)s" --exec 'echo $album; echo {}' $1
	youtube-dl -i -f bestaudio -o "%(title)s.%(ext)s" --recode-video ogg "$1" --write-info-json
}

rename_tag_and_place(){ # renames all files and moves to directory $artist/$album ($1/$2)
	artist="$1"
	album="$2"
	dir=""
	if [ -n "$album" ]
	then
		dir="$artist/$album"
	else
		dir="$artist"
	fi
	mkdir -p "$dir"
	for file in *.ogg
	do
		echo "$file"
		title=$(echo "$file" | sed -r "s/(.+?) ?- ?(.+)/\2/" | sed -r "s/([^\(]*).*/\1/" | sed -r "s/[ \t]+$//" | sed -r "s/\..*$//")
		echo "title: $title"
		id3v2 --artist "$artist" --song "$title" --album "$album" "$file"
		id3v2 -l "$file"
		mv "$file" "$dir"
	done
	mv Folder.jpg "$dir"
}

move_audio(){
	echo "Copying it to the right directories"
	find -mindepth 1 -maxdepth 1 -type d -print -exec cp {} /mnt/nas/moveToPhone -r \;
	find -mindepth 1 -maxdepth 1 -type d -print -exec cp {} /mnt/nas/Music -r \;
}


if (( $# > 4 || $# < 2))
then
	usage
	exit 2
fi
# tempDir=`mktemp -p /mnt/nas/tmp -d`
tempDir=`mktemp -p /tmp/ -d`
cd "$tempDir"
pwd
download_audio $1 $2
if [ -n "$4" ]
then
	wget "$4" -O Folder.jpg
fi
extract_metadata.py $tempDir
rename_tag_and_place $2 $3
# move_audio
