#!/bin/zsh

# how to call:
# ytAudio "Artist" "Album" "Song name"
# or: ytAudio "Artist" "Song name"
# or: ytAudio URL

usage()
{
	echo "Usage:"
	echo "$(basename $0) -a ARTIST -A ALBUM [-c ALBUMCOVER] [-n] URL "
	echo "-n: Don't recode to ogg"
}

download_audio(){
	# export album="$2"
	# youtube-dl -f bestaudio --write-thumbnail -o "%(title)s.%(ext)s" --exec 'echo $album; echo {}' $1
	youtube-dl -i -f bestaudio -o "%(title)s.%(ext)s" --recode-video ogg "$1" --write-info-json
}

rename_tag_and_place(){ # renames all files and moves to directory $artist/$album ($1/$2)
	artist="$1"
	album="$2"
	dir=""
	if [ -n "$album" ]
	then
		dir="$artist/$album"
	else
		dir="$artist"
	fi
	mkdir -p "$dir"
	for file in *.ogg
	do
		echo "$file"
		title=$(echo "$file" | sed -r "s/(.+?) ?- ?(.+)/\2/" | sed -r "s/([^\(]*).*/\1/" | sed -r "s/[ \t]+$//" | sed -r "s/\..*$//")
		echo "title: $title"
		id3v2 --artist "$artist" --song "$title" --album "$album" "$file"
		id3v2 -l "$file"
		mv "$file" "$dir"
	done
	mv Folder.jpg "$dir"
}

move_audio(){
	echo "Copying it to the right directories"
	find -mindepth 1 -maxdepth 1 -type d -print -exec cp {} /mnt/nas/moveToPhone -r \;
	find -mindepth 1 -maxdepth 1 -type d -print -exec cp {} /mnt/nas/Music -r \;
}

declare ARTIST
declare ALBUM
declare COVER
declare HASCOVER

while getopts 'ha:A:c:' c
do
	case $c in
		h) usage; exit ;;
		a) ARTIST="$OPTARG" ;;
		A) ALBUM="$OPTARG" ;;
		c) COVER="$OPTARG"; HASCOVER=1; ;;
	esac
done

shift $((OPTIND-1))

# if [ ( -z "asdf" ) -o ( -z "$ALBUM" ) ]
if [ -z "$ARTIST" -o -z "$ALBUM" ]
then
	echo "Please provide an artist and album"
	echo "$ARTIST"
	echo "$ALBUM"
	usage
	exit 2
fi

# tempDir=`mktemp -p /mnt/nas/tmp -d`
tempDir=`mktemp -p /tmp/ -d`
cd "$tempDir"
pwd
exit
download_audio "$ARTIST" "$ALBUM"
if [ ! -z $HASCOVER ]
then
	wget "$COVER" -O Folder.jpg
fi
rename_tag_and_place "$ARTIST" "$ALBUM"
# extract_metadata.py $tempDir
# move_audio
